name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Permite ejecutar manualmente desde GitHub

env:
  DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
  DEPLOY_USER: ${{ secrets.DEPLOY_USER }}

jobs:
  # Job 1: Validaciones b√°sicas antes del deploy
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate HTML
        run: |
          echo "üîç Validating critical files exist..."
          test -f index.html || exit 1
          test -f api/app.py || exit 1
          echo "‚úÖ All critical files present"
      
      - name: Check for secrets in code
        run: |
          echo "üîí Scanning for exposed secrets..."
          ! grep -rE "(password|secret|api_key)\s*=\s*['\"][^'\"]+['\"]" --include="*.py" --include="*.js" . || echo "‚ö†Ô∏è Warning: Potential secrets found"
          echo "‚úÖ Secret scan complete"

  # Job 2: Deploy al servidor
  deploy:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to server
        run: |
          echo "üöÄ Starting deployment..."
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} 'bash /home/deploy.sh'
          echo "‚úÖ Deployment complete"
      
      - name: Health check
        run: |
          echo "üè• Running health checks..."
          sleep 10
          curl -f https://${{ secrets.DEPLOY_DOMAIN }}/api/health || echo "‚ö†Ô∏è Main API health check failed"
          echo "‚úÖ Health checks complete"

  # Job 3: Notificaci√≥n (opcional)
  notify:
    needs: deploy
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Deployment status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ Deployment successful!"
          else
            echo "‚ùå Deployment failed!"
            exit 1
          fi
